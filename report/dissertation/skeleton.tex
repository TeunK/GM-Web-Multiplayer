% to choose your degree
% please un-comment just one of the following
\documentclass[bsc,frontabs,twoside,singlespacing,parskip,deptreport]{infthesis}     % for BSc, BEng etc.
% \documentclass[minf,frontabs,twoside,singlespacing,parskip,deptreport]{infthesis}  % for MInf

\usepackage{float} %for image positioning
\usepackage[hidelinks]{hyperref} %clickable url, hide url box
\usepackage{xcolor} %paint url, links and citations
\hypersetup{
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}
\usepackage[T1]{fontenc} %fix < > characters

\begin{document}

\title{A Network Extension for GameMaker HTML5}

\author{Teun Kokke}
\course{Software Engineering} 
\project{Undergraduate Dissertation} % CS&E, E&SE, AI&L

\date{\today}

\abstract{
summarising the report\\
Creating an extention for GameMaker creations, to allow fast networking with maximal reliability.
}

\maketitle

% REMOVE THESE >>>>
\section*{Questions to Dr. Lee}
\begin{itemize}
\item What to reference? stackoverflow? is it legit?
\item How does "related work" apply to "other game developer engines", when my work is to improve one, not to build one?
\item Need to mention examples in background for "why gamemaker"? if no, where should examples be given if at all?
\item Is there a difference between a "software engineering" and a "computer science" dissertation? Consider software engineering main focus is more likely to be "implementation", "coding standards", "design standards" and "best practices". My case involves writing a script that extends an existing system. Therefore there is relatively little "implementation" work compared to those where a complete system is built. Thus how much additional underlying "research" (as opposed to "stackoverflow user solutions") is required to compensate?
\item Known from previous experiments: a single instance cannot simulate more than roughly 700 clients without causing losing stability. Do I have to show this in detail with a graph as part of the evaluation experiments to justify the reason why I allowed at most 500 clients per instance? or should I instead just mention that eg. 500 clients per instance is arbitrary for this reason and ignore the details?
\item Is it required to include formulae for mean, variance and standard-deviation?
\end{itemize}

\section*{TODO}
\begin{itemize}
\item give definition for server-reponse time
\item in section "fairness depending on location", add world map with tested locations and their average mean
\item Consider actual playability in a game OR add assumption how RTT affects atual usage of an application (find reference?)
\item fill in further details on experiment setup (text format)
\item Write down details about implementation
\item Possibly add new implementation features / clean up existing implementations.
\end{itemize}
% <<<< REMOVE THESE

\pagebreak
\section*{Acknowledgements}
First of all, I would like to thank my supervisor Dr. Myungjin Lee for guiding me through the process of writing the report and critisizing my work.

I am also grateful to those people across the globe who have assisted me with testing and collecting data for the evalutation experiments.

My sincere gratitude to my family, friends, the Dutch Gamemaker community and the Yoyogames forums, for providing me with feedback and ideas without which this project would not have been the same.

\section*{List of Acronyms}
\begin{itemize}
\item API - Application Program Interface
\item IP - Internet Protocol
\item TCP - Transmission Control Protocol
\item UDP - User Datagram Protocol
\item W3C - World Wide Web Consortium
\item P2P - Peer-to-Peer
\item RTT - Roundtrip Time
\item RSS - Resident Set Size
\item CPU - Central Processing Unit
\item RAM - Random Access Memory
\item LAN - Local Area Network
\end{itemize}

\tableofcontents
%\pagenumbering{arabic}



% START THE REAL CONTENT

% -----------------------
\chapter{Background and Related Work}
\section{Background}
%intro and synopsis (topic description and setting context of published literature, main results summarized.. about 5 pages)
%- summary of ALL contributions, code, research interpretations, tests, experiments (bulleted list)
In the current day and age, we spend a large portion of our time using web applications. A vast amount of the internet consists of services supported by web applications, and browser games are as popular as ever.

There exist many good reasons for this. Browser applications and games do not require prior installation. They are therefore easy to start up, safe from viruses and don't require an admin-user account in order to be executed\cite{Web_Apps_Superior}. They are able to interact with other web applications. They are highly platform independent and potential users are generally easy to reach. Also their updates are seamless and can be implemented without requiring patch downloads to a harddrive.
\subsection{Networks in Applications}
%include minimal requirements
%which criteria to consider when testing a network
Humans are naturally social beings, are found to be more drawn into games when this social aspect is being provided, and are therefore more likely to return in the future\cite{Browser_Games}. When allowed, we can share a sense of community, develop our own social identity within the application, and regularly seek social support from peer users, even about non-related and real-life topics\cite{Community_Social_Psychology}. Users of networked applications are \textbf{more likely to advertise} the application in their social circles than they are for non-networked applications.

\subsection{Network Fairness}
Having that said, one must consider the technical aspect of the network: if the application is in the form of a game, \textbf{playability and fairness are crucial for an enjoyable gameplay}. This is especially true for games containing elements where speed or response time is important.

In a typical networked game, game clients are described by a \textbf{limited set of parameters} received by a server. These parameters represent the "game state". \textbf{When due to delay between the clients and server the game state is desynchronised, fairness is reduced}\cite{Fairness_and_Playability}.

\subsection{TCP versus UDP}
Choosing the right protocol to handle the data transmissions is therefore crucial. Transmission protocols are one of the contributors that will heavily characterise the network.
 
Generally speaking, TCP is a form of reliable data transmission but contains therefore extra overhead, making it therefore known to be slightly slower than UDP when the network has little packet loss.

\subsubsection{Socket.io}
Socket.io is an event-driven JavaScript library that can be used both on the client's browser, and a server\cite{Socketio}. It is capable of sending and receiving data using the WebSocket protocol built in 2011 (which is handled through TCP), without interruption of the code flow\cite{Socketio_Benchmark}\cite{Socketio_TCP_Benchmark}. For this reason, it is \textbf{often used in combination with Node.js}.

\subsubsection{WebRTC}
As aforementioned, Websocket is a protocol built on TCP. However, it has a little sister: WebRTC. WebRTC built on UDP, but is still vaguely "under construction"\cite{Browser_Networking}. Although certain web applications have already been created with WebRTC (mainly for P2P video streaming \cite{P2P_Video_Streaming_HTML5_WebRTC}), no proper standards are out yet\cite{Web_Apps_Superior}.

This, combined with requirement of manually specifying the rules of communication, as well as the fact that WebRTC has to circumvent network security and privacy in order to allow web browsers to transmit data over UDP\cite{P2P_Video_Streaming_HTML5_WebRTC}, makes UDP many times \textbf{more complicated} for developers to handle efficiently.

\subsection{HTML5}
\paragraph{}HTML5 is a raising web standard released in 2014 by the W3C. It is designed to be \textbf{cross-platform} and runs on most modern web browsers such as Google Chrome, Mozilla Firefox, Apple Safari, and Opera \footnote{HTML5 supported browsers are found at \url{https://html5test.com/results/desktop.html}}. Also mobile web browsers that come preinstalled on iPhones, iPads and Android phones support HTML5.

It superseeds its predecessors HTML4 and XHTML1.1 with the aim to reduce the dependence of functionality from third-party plugins such as Flash and Java applets, which are either deprecated or entirely unsupported by most devices \cite{Death_Flash_Java}.

Scripting is replaced in HTML5 by markup where possible, causing the world of browser-gaming to change rapidly. One of the the newly introduced features is the <canvas> element, which is defined as "a resolution-dependent bitmap canvas which can be used for rendering graphs, game graphics or other visual images on the fly"\cite{HTML5_Up_and_Running}. \textbf{The element can thus be used to draw graphics in JavaScript with the "Canvas API"}\cite{Canvas_API}.

\subsection{Node.js}
%include socket.io %benchmarks for socket.io made by other developers
Traditionally, servers create a separate thread for each client, therefore rapidly running out of RAM and keeping clients on hold until memory for a new thread is released\cite{Why_Nodejs}.

Node.js is a JavaScript interface with the aim to create "real-time websites with push capability" allowing developers to work in the "non-blocking event-driven I/O paradigm" \cite{Why_Nodejs}. This means that developers can use it to create real-time web applications where a server and client can both initiate communication, and that both can exchange data freely without repeatedly having to refresh the webpage.

In short, new client connections get allocated to a heap in the memory and client events are handled on a single thread by the server's operating system without choking the (Node.js) event loop. \textbf{This therefore allows servers running Node.js to maintain thousands of concurrent connections without running out of RAM memory}\cite{Node_Stress_Test}\cite{NodeJS_Image}, as opposed to the traditional, less scalable servers.


\subsection{GameMaker}
%include its evolution and typical target audience
%explain the types of target audience, who do the developers of an application using the extension intend to target. How does this affect the demands on the network
%focus on location of users
GameMaker by YoYoGames is a software creation tool with the aim to simplify and speed up game and app development. There have been several hits on the market for games developed with Gamemaker such as "Reflections", "Rick O'Shea" and "Simply Solitaire" \cite{Gamemaker_DnD}.

Developing applications and games in GameMaker is cheap, simple to learn and flexible to use, making the software demanded by small teams, professionals and novice developers \cite{Mark_Overmars}. Sandy Duncan, the founder and former chief executive officer of YoYoGames stated in a phone interview that they have never lost money on a game that they developed with their technology\cite{Gamemaker_DnD}.

During the rise of HTML5 and the growing popularity of Gamemaker, YoyoGames has provided the functionality to export any application to a JavaScript program that can be executed directly in the browser\cite{GameMaker_Studio}.

Some of the features are normally supported by GameMaker are however lost during the transition to a web application. One of these features is the networking functionality. Thus far since the update to export GameMaker applications to HTML5 in September 2011, YoYoGames has never included this feature\footnote{http://docs.yoyogames.com/source/dadiospice/002\_reference/networking/index.html}. Several attempts have been made by the YoYoGames community, however all known versions are considered to be in alpha stage and are regularly found to fail to be used by other developers.
\footnote{http://gmc.yoyogames.com/index.php?showtopic=520438}
\footnote{http://gmc.yoyogames.com/index.php?showtopic=332957}

The implementation in this Honours project will allow developers to again add networking features to their web-browser applications.

\section{Related Work}
Being primarily a 2D graphically oriented game development tool for almost any imaginable platform, it has many competitors. Therefore we must remind ourselves of the main focus of this project: improving the HTML5-export feature. 

For this reason, I shall from this point consider GameMaker to be a purely browser-oriented application / game development tool and will therefore also treat it as such.

In order to further reduce the variety of software that can be used for creating browser games, I found help online from instances hosting tables with the "best-rated browser game development tools" on the market. These ratings were established by providing feedback based on users personal experience.

The tables were hosted at the following domains:
html5gameengine.com\footnote{https://html5gameengine.com/}, 
developer.mozilla.org\footnote{https://developer.mozilla.org/en-US/docs/Games/Tools/Engines\_and\_tools}, 
gamepix.com\footnote{http://www.gamepix.com/blog/the-big-list-of-html5-3d-games-engines/}, 
noeticforce.com\footnote{http://noeticforce.com/best-3d-javascript-game-engines-frameworks-webgl-html5} and 
develop-online.net\footnote{http://www.develop-online.net/news/the-top-14-game-engines-the-list-in-full/0114330}.

Any non-2D engines, not-browser-supported engines, as well as engines without a clear graphical interface were removed. After this process, the following list remains:
\begin{itemize}
\item Construct 2 (also mentioned by Duncan during a phone interview\cite{Gamemaker_DnD})
\item ImpactJS
\item EaseIJS
\item Phaser
\item pixi.js
\item Canvace
\item Crafty
\end{itemize}

\subsection{CoronaSDK}
\subsection{Gideros Studio}
\subsection{Maoi}

\subsection{JSiso}http://jsiso.com/
\subsection{Unity}






% -----------------------
\chapter{Literature Review}

\section{Getting Users to Advertise Your Application}
literature related to networking applications in order to connect users such that they will want to invite their social circles to the game.

\section{Fairnesss and Playability in Online Multiplayer Games}
more detail on Network Fairness, causes and fixes to unfairness (see background section)

\section{Multiplayer Networking in Modern Game Engines}
game state maintained through a limited set of parameters

\section{Details Why WebRTC is Complicated to Handle Efficiently}
how does WebRTC work, why it is not suggested for the implementation and why it otherwise would

\section{Drawing Graphics with the HTML5 Canvas API}
basics to drawing graphics in html5 <canvas> element

\section{Creating Extensions for GameMaker Studio}
how to create an extension to GameMaker



% -----------------------
\chapter{Development}
%discussion of work undertaken, sub-problems, solutions, difficulties
%\\- concentrated discussions for implementation principles and aspects
%\\- clarify WHAT WAS COMPLETED, and what wasnt.
\section{Design}
%about the high level design ideas / structure and templates for other developers, make clear connection with literature review
\subsection{Prior Considerations}
%How to make it easy for other developers to create applications with the extension. eg. Creating templates
%project layout (modularisation / separation of concerns). client, server, benchmark application, equality application, user experience
\subsection{Server and Client}
%how do applications communicate
%IMPORTANT: State why there is no need for testing fairness between different bandwidths for web applications. (ie. games and web-apps only really need to send small variables, no big data is transported)
\subsubsection{Good Coding Practices}
\subsubsection{Interaction}
%Mapping from GML to the extension

\section{Implementation}
\subsection{Server}
\subsection{Client}
\subsection{The Extension}
\section{Applications Developed with the Extension}
%Explain about ownmade application using the extension, how it tests the given benchmarks (eg. delay, data, equality)
\subsection{Benchmark Application}
\subsection{Real Game Application}
\subsection{Developer Template}







% -----------------------
\chapter{Network Extension Evaluation}
%description of experiments, presentation + (directly including) interpretation of the data
\section{Setup}
%explain every detail of how the experiments were setup, how everything worked.
%Note: add reminder that developers can setup peer-to-peer network by using the extension to serve as both server and client in their client application, but that these tests specifically consider the strength of each individual application acting as server.

\subsection{Controlled Network Experiments}
The controlled experiments were conducted in order to predict server behaviour when loaded under similar pressure in future occasions. 

\subsubsection{Concurrent Connections Specifics}
\paragraph{Environment}
\begin{itemize}
\item Variable number of concurrent connections cc, up to 15 instances with each simulating at most 500 clients.
\item Clients do not contact the server after establishing a connection.
\item The CPU usage, time and RSS (Resident set size) are recorded after each every time another group of 100 clients connect to the server.
\end{itemize}
\paragraph{Dependent variables}
\begin{itemize}
\item CPU usage on the server
\item CPU time on the server
\item RSS on the server
\end{itemize}

\subsubsection{Message Broadcasting Specifics}
\paragraph{Environment}
\begin{itemize}
\item 5000 concurrent connections (10 instances each simulating at most 500 clients).
\item Each package that is sent has a size of 8 bytes.
\item Each client sends packages at regular time intervals, causing the server to handle n messages every second.
\item Each client measures the roundtrip time of its package to the server.
\end{itemize}

\paragraph{Dependent variables}
\begin{itemize}
\item Mean roundtrip time between all clients
\item Variance of the roundtrip time between all clients
\item Standard Deviation of the roundtrip time between all clients
\end{itemize}

\subsubsection{Server hardware and network specification}
\paragraph{}The controlled network experiments were executed on a Windows 7 64-bit platform with 12.6GB available physical memory and an Intel(R) Core(TM) i7-2600K CPU @ 3.40GHz processor. The software included Node v0.12.3 and Socket.io v1.3.7 in order to handle the networking operations.

The network was controlled using Dummynet, using a below-average UK household network setup. This involves an upload speed of 5Mbit/s, and a download speed of 1Mbit/, although no packet loss was set in order to ensure consistency throughout the controlled network experiments.

\subsection{Real Network Experiments}
The network was consistently running with a 54.0Mb/s download and 3.0Mb/s upload speed.
\paragraph{}Multiple tests were executed with clients being located at specified locations. In each case, the clients were sending 8-byte messages to the server at a regular interval of 1 second for 2 minutes. The 120 roundtrip times for each client were then averaged in order to blur occasional peaks. At this point the roundtrip times of the clients in each common location were averaged, and then the deviance of the roundtrip times at each of these locations were calculated.

All network experiments were executed using a single server located in Edinburgh and in each experiment all clients were connected and communicating to that server simultaneously.

\section{Results}
\subsection{Controlled Network Results}
\subsubsection{Concurrent Connections}
The following experiment evaluates the server performance with regard to the number of clients.

\begin{center}
\begin{figure}
\centering
% \centering% default with `floatrow`
\includegraphics[scale=0.75]{images/test_CLIENT_CPUusage.jpg}
\caption{Displaying the CPU usage for the server process in percent.}
\label{fig:cpu_usage}
\vspace{1em}
When the CPU usage is above 70 percent, the user may experience lag. Such high CPU usage indicates insufficient processing power. Either the CPU needs to be upgraded, or the user experience reduced.
\end{figure}

\begin{figure}
\centering
% \centering% default with `floatrow`
\includegraphics[scale=0.75]{images/test_CLIENT_CPUtime.jpg}
\caption{CPU time in milliseconds, displaying the amount of time required for the server to process the clients.}
\label{fig:cpu_time}
\end{figure}

\begin{figure}
\centering
% \centering% default with `floatrow`
\includegraphics[scale=0.75]{images/test_CLIENT_RSS.jpg}
\caption{Resident set size in Megabit, showing the portion of RAM that is occupied by the server process.}
\label{fig:cpu_rss}
\end{figure}

\end{center}


\subsubsection{Message Broadcasting Performance}
The following experiment evaluates the number of messages that can be handled by the server simultaneously, and considers how this affects the fairness in response-time of the individual clients.

\begin{center}

\begin{figure}[h]
\centering
% \centering% default with `floatrow`
\includegraphics[scale=0.32]{images/test_SERVER_RTTmean.jpg}
\caption{The mean roundtrip time of all the messages that pass through the server. As expected, with few concurrent clients connected to the server, the server manages to broadcast many more messages.}
\label{fig:broadcast_rtt_mean}
\end{figure}


\begin{figure}
\centering
% \centering% default with `floatrow`
\includegraphics[scale=0.32]{images/test_SERVER_RTTvariance.jpg}
\caption{The variance of the roundtrip times, showing the fairness between clients decreases significantly when the server receives messages faster than it can broadcast.}
\label{fig:broadcast_rtt_variance}
\end{figure}


\begin{figure}
\centering
% \centering% default with `floatrow`
\includegraphics[scale=0.32]{images/test_SERVER_RTTstd.jpg}
\caption{Standard deviation of the message roundtrip times.}
\label{fig:broadcast_rtt_std}
\end{figure}

\end{center}



\subsection{Real Network Results}
\subsubsection{Location-wise Delay Fairness}
The following experiment evaluates the effect of the geographical distance between groups of clients and the server with respect to fairness in response-time from the server to the clients.

\paragraph{Test cases:}
\begin{enumerate}
\item Local network setting: Five clients physically located in the same local home network.

\item Same city: Five clients physically located in Edinburgh (LAN excluded).

\item Same country: Three clients physically located in Scotland: Edinburgh, Glasgow and Dundee.

\item Europe: Five clients physically located in the United Kingdom, Hungary, France, Germany and the Netherlands.

\item Inter-continental: Eight clients physically located in South Africa, California (USA), India, Thailand, Germany, Hungary, United Kingdom and the Netherlands.

\end{enumerate}

\paragraph{Results:}Average roundtrip times per location:
\begin{center}
  \begin{tabular}{ r | l }
Location		& Average RTT \\ \hline\hline
LAN				& 32ms	\\
Edinburgh		& 55ms	\\
Dundee			& 65ms	\\
Germany			& 67ms	\\
Glasgow			& 68ms	\\
France			& 69ms	\\
the Netherlands	& 70ms	\\
United Kingdom	& 71ms	\\
Hungary			& 76ms	\\
India			& 103ms	\\
South Africa	& 144ms	\\
California (USA)& 158ms	\\
Thailand		& 171ms	\\
  \end{tabular}
\end{center}

Average roundtrip times per test:
\begin{center}
  \begin{tabular}{ | r || c | c | c | c | c |}
    \hline
    Test case 		& 1 		& 2 		& 3 		& 4 		& 5 		\\ \hline\hline
    Mean RTT 		& 32.1ms 	& 54.8ms 	& 62.7ms 	& 70.6ms 	& 107.5ms	\\ \hline
    Variance RTT 	& 1.3ms 	& 8.2ms 	& 46.3ms 	& 11.3ms 	& 1900.9ms	\\ \hline
    Std RTT			& 0.4ms		& 2.9ms		& 6.8ms		& 3.36ms	& 43.6ms	\\ \hline
  \end{tabular}
\end{center}



% -----------------------
\chapter{Conclusion and Future Work}
\section{Conclusion}
\subsection{Comparison of the Extended GameMaker Functionality with Related Work}
\subsection{Criticism on the Implementation and Design Decisions}
%make clear connection with the evaluation

\section{Future Improvements}






% -----------------------
% >>>> REMOVE THIS BLOCK
\cite{Multiplayer_Networking_modern_engine}
\cite{Fairness_and_Playability}
\cite{Pro_HTML5_Programming}
\cite{HTML5_Up_and_Running}
\cite{Friendly_Programming}
\cite{Mark_Overmars}
\cite{Death_Flash_Java}
\cite{Why_Nodejs}
\cite{Node_Stress_Test}
\cite{NodeJS_Image}
\cite{Socketio_Benchmark}
\cite{Socketio_TCP_Benchmark}
\cite{Socketio}
\cite{Canvas_API}
\cite{Web_Apps_Superior}
\cite{Community_Social_Psychology}
\cite{Why_MMOG}
\cite{Browser_Games}
\cite{Browser_Networking}
\cite{Web_Apps_Superior}
\cite{P2P_Video_Streaming_HTML5_WebRTC}
\cite{Gamemaker_DnD}
\cite{GameMaker_Studio}
\cite{Optimizing_Multiplayer_3D_Game_Synch}
\cite{Optimizing_WebSockets_Bandwidth}
% <<<< REMOVE THIS BLOCK

\bibliographystyle{unsrt}
\bibliography{mybibfile}

\end{document}
